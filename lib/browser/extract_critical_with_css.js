module.exports=(({sourceAst:e,loadTimeout:t,keepSelectors:r})=>new Promise((s,n)=>{const o=["media","rule"],l=new RegExp(["after","before","first-line","first-letter","selection","visited"].map(e=>":?:"+e).reduce((e,t)=>e+"|"+t),"g"),i=new RegExp(/:?:-[a-z-]*/g);r=r||[],t=t||2e3;const c=window.innerHeight,a=new Set,u=new Map,d=(e,t)=>{window.requestAnimationFrame(()=>{Date.now()-e>=t?window.stop():d(e,t)})};d(Date.now(),t);const f=e=>(e.indexOf(!1)&&(e=e.replace(l,"")),e.indexOf(!1)&&(e=e.replace(i,"")),e),p=e=>r.includes(e),w=e=>{if(a.has(e))return!0;return!!(e.getBoundingClientRect().top<c)&&(a.add(e),!0)},m=(e,t)=>{const r=(t=t||"")+e;((e=>e.startsWith(":"))(e)||(e=>{if(p(e))return!0;const t=f(e);let r;try{r=document.querySelectorAll(t)}catch(e){return!1}const s=r.length;for(let e=0;e<s;e++)if(w(r[e]))return!0;return!1})(e))&&(u.has(r)||u.set(r,{selector:e,media:t}))},g=e=>{let t=[],r=null;e.stylesheet?t=e.stylesheet.rules||[]:e.rules&&"media"===e.type?(t=e.rules||[],r=e.media):console.warn("Missing ast rules!!!",e.type,e.stylesheet);for(let e of t)if(o.includes(e.type))if("media"===e.type)g(e);else{const t=e.selectors||[];for(let e of t)m(e,r)}else console.debug("DEBUG: UNPROCESSED RULE TYPE: "+e.type)};return g(e),s([...u])}).catch(e=>{console.error(e)}));