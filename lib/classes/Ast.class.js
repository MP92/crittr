const _=require("lodash"),log=require("signale"),CONSTANTS=require("../Constants"),Rule=require("./Rule.class"),hash=require("object-hash"),REMOVEABLE_PROPS=["position"],cleanUnusedProperties=e=>{for(let s in e){REMOVEABLE_PROPS.includes(s)&&delete e[s];const t=e[s];(Array.isArray(t)||"object"==typeof t)&&cleanUnusedProperties(t)}},handleRule=(e,s)=>{if(!Rule.isComment(e))if(cleanUnusedProperties(e),Rule.isMediaRule(e)){const t=Ast.MEDIA_PREFIX+e.media,l=s.get(t),r=e.rules;if(l&&l.length>0){const e=r.filter(e=>{const s=hash.MD5(e);return!l.some(e=>e.hash===s)}).map(e=>({hash:hash.MD5(e),rule:e}));s.set(t,[...l,...e])}else s.set(t,r.map(e=>({hash:hash.MD5(e),rule:e})))}else{const t=Rule.generateRuleKey(e),l=s.get(t),r=hash.MD5(e);l?l.some(e=>e.hash===r)||l.push({hash:r,rule:e}):s.set(t,[{hash:r,rule:e}])}};class Ast{static generateRuleMap(e,s=new Map){if(e.type&&"stylesheet"===e.type&&e.stylesheet&&Array.isArray(e.stylesheet.rules)){const t=e.stylesheet.rules;for(const e of t)handleRule(e,s)}return s}static getAstOfRuleMap(e){const s={type:"stylesheet",stylesheet:{rules:[]}},t=s.stylesheet.rules;for(let[s,l]of e)if(s.includes(Ast.MEDIA_PREFIX)){const e=s.replace(Ast.MEDIA_PREFIX,"");t.push({type:"media",media:e,rules:l.map(e=>e.rule)})}else t.push(...l.map(e=>e.rule));return s}static isMediaObj(e){return e.includes(Ast.MEDIA_PREFIX)}}Ast.TYPES_TO_REMOVE=["comment"],Ast.MEDIA_PREFIX="@media ",module.exports=Ast;