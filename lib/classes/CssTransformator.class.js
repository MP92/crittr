"use strict";const _=require("lodash"),debug=require("debug")("Crittr CSSTransformator"),log=require("signale"),merge=require("deepmerge"),css=require("css"),Rule=require("./Rule.class");class CssTransformator{constructor(e){e=e||{},this.options={silent:!0,source:null},this.options=merge(this.options,e);this.CRITICAL_TYPES_TO_KEEP=["media","rule","charset","font-face"];const s=[":before",":after",":visited",":first-letter",":first-line"].map(e=>":?"+e).join("|");this._PSUEDO_SELECTOR_REGEXP=new RegExp(s,"g")}getAst(e){let s=null;try{debug("getAst - Try parsing css to ast ..."),s=css.parse(e,{silent:this.options.silent,source:this.options.source}),debug("getAst - Css successfully parsed to ast ...")}catch(e){log.error(e)}return s}getCssFromAst(e){return css.stringify(e,{indent:"  ",compress:!1,sourcemap:!0,inputSourcemaps:!0})}filterByMap(e,s){let t=JSON.parse(JSON.stringify(e)),r=JSON.parse(JSON.stringify(e));const l=t.stylesheet,i=r.stylesheet;let u=[];const o=new Map,n=(e,s,t)=>{s=s||"";const r=Rule.generateRuleKey(e,s);if(t.has(r)){const s=t.get(r);return e.selectors.filter(e=>s.selectors.includes(e))}return[]};let c=l.rules.filter(e=>this.CRITICAL_TYPES_TO_KEEP.includes(e.type));c=(c=c.map((e,t,r)=>{if("media"===e.type)e.rules&&(e.rules=e.rules.map(t=>{const r=Rule.generateRuleKey(t,e.media);return t.selectors=n(t,e.media,s),o.set(r,t.selectors),t}).filter(e=>void 0!==e.selectors&&e.selectors.length>0),0===e.rules.length&&u.push(e));else if("rule"===e.type){const t=Rule.generateRuleKey(e);e.selectors=n(e,"",s),o.set(t,e.selectors),0===e.selectors.length&&u.push(e)}return e})).filter(e=>!u.includes(e)),u=[];let a=i.rules.map(e=>{const s="media"===e.type?e.media:"";if("media"===e.type)e.rules&&(e.rules=e.rules.map(e=>{const t=Rule.generateRuleKey(e,s);if(o.has(t)){const s=o.get(t);e.selectors=e.selectors.filter(e=>!s.includes(e))}return e}).filter(e=>void 0!==e.selectors&&e.selectors.length>0),0===e.rules.length&&u.push(e));else if("rule"===e.type){const t=Rule.generateRuleKey(e,s);if(o.has(t)){const s=o.get(t);e.selectors=e.selectors.filter(e=>!s.includes(e))}0===e.selectors.length&&u.push(e)}return e});return a=a.filter(e=>!u.includes(e)),l.rules=c,i.rules=a,[t,r]}}module.exports=CssTransformator;