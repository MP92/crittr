module.exports=(({sourceAst:e,loadTimeout:t,keepSelectors:r,removeSelectors:s})=>new Promise((n,o)=>{const l=["media","rule"],i=new RegExp(["after","before","first-line","first-letter","selection","visited"].map(e=>":?:"+e).reduce((e,t)=>e+"|"+t),"g"),c=new RegExp(["root"].map(e=>":?:"+e).reduce((e,t)=>e+"|"+t),"g"),u=new RegExp(/:?:-[a-z-]*/g);r=r||[],s=s||[],t=t||2e3;const a=window.innerHeight,d=new Set,f=new Map,p=(e,t)=>{window.requestAnimationFrame(()=>{Date.now()-e>=t?window.stop():p(e,t)})};p(Date.now(),t);const m=e=>{if(h(e))return!0;if(y(e))return!1;const t=w(e);let r;try{r=document.querySelectorAll(t)}catch(e){return!1}const s=r.length;for(let e=0;e<s;e++)if(E(r[e]))return!0;return!1},w=e=>(e.indexOf(!1)&&(e=e.replace(i,"")),e.indexOf(!1)&&(e=e.replace(u,"")),e.indexOf(!1)&&(e=e.replace(c,"")),e),g=e=>e.startsWith(":")&&null===e.match(c),h=e=>r.includes(e),y=e=>s.includes(e),E=e=>{if(d.has(e))return!0;return!!(e.getBoundingClientRect().top<a)&&(d.add(e),!0)},x=e=>{let t={},r=null;e.stylesheet?t=e.stylesheet:e.rules&&"media"===e.type?(t=e,r=e.media):console.warn("Missing ast rules!!!",e.type,e.stylesheet);const s=t.rules;for(let e of s)if(l.includes(e.type))if("media"===e.type)x(e);else{const t=e.selectors||[],s=(r=r||"")+t.join();for(let n of t)if(g(n)||m(n))if(f.has(s)){const e=f.get(s);e.selectors.includes(n)||e.selectors.push(n)}else f.set(s,{selectors:[n],media:r,rule:e})}else console.debug("DEBUG: UNPROCESSED RULE TYPE: "+e.type)};return x(e),n([...f])}).catch(e=>{console.error(e)}));