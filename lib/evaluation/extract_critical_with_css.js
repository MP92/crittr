module.exports=(({sourceAst:e,loadTimeout:t,keepSelectors:r,removeSelectors:s})=>new Promise((n,o)=>{const l=["media","rule"],i=new RegExp(["after","before","first-line","first-letter","selection","visited"].map(e=>":?:"+e).reduce((e,t)=>e+"|"+t),"g"),c=new RegExp(["root"].map(e=>":?:"+e).reduce((e,t)=>e+"|"+t),"g"),u=new RegExp(/:?:-[a-z-]*/g);r=r||[],s=s||[],t=t||2e3;const a=window.innerHeight,d=new Set,p=new Map,f=(e,t)=>{window.requestAnimationFrame(()=>{Date.now()-e>=t?window.stop():f(e,t)})};f(Date.now(),t);const m=e=>{if(y(e))return!0;if(E(e))return!1;const t=g(e);let r;try{r=document.querySelectorAll(t)}catch(e){return!1}const s=r.length;for(let e=0;e<s;e++)if(x(r[e]))return!0;return!1},g=e=>(e.indexOf(!1)&&(e=e.replace(i,"")),e.indexOf(!1)&&(e=e.replace(u,"")),e.indexOf(!1)&&(e=e.replace(c,"")),e),w=e=>e.startsWith(":")&&null===e.match(c),h=e=>(e="^"+e.replace(/([.*><+~])/g,"\\$1").replace(/%/g,".*")+"$",new RegExp(e,"gm")),y=e=>r.includes(e)||r.some(t=>{return h(t).test(e)}),E=e=>s.includes(e)||s.some(t=>{return h(t).test(e)}),x=e=>{if(d.has(e))return!0;return!!(e.getBoundingClientRect().top<a)&&(d.add(e),!0)},R=e=>{let t={},r=null;e.stylesheet?t=e.stylesheet:e.rules&&"media"===e.type?(t=e,r=e.media):console.warn("Missing ast rules!!!",e.type,e.stylesheet);const s=t.rules;for(let e of s)if(l.includes(e.type))if("media"===e.type)R(e);else{const t=e.selectors||[],s=(r=r||"")+t.join();for(let n of t)if(w(n)||m(n))if(p.has(s)){const e=p.get(s);e.selectors.includes(n)||e.selectors.push(n)}else p.set(s,{selectors:[n],media:r,rule:e})}else console.debug("DEBUG: UNPROCESSED RULE TYPE: "+e.type)};return R(e),n([...p])}).catch(e=>{console.error(e)}));